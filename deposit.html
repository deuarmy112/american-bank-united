<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deposit - American Bank United</title>
  <script>
    if (!localStorage.getItem('authToken')) {
      window.location.href = 'index.html';
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/opay.css">
  <style>body{background:#f8fafc;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}</style>
</head>
<body class="opay-ui">
  <script>
    // Remove any stray filename text or elements that show 'deposit.html'
    try{
      // remove text nodes under body that contain the filename
      Array.from(document.body.childNodes).forEach(n=>{
        if (n && n.nodeType===Node.TEXT_NODE && n.textContent && n.textContent.indexOf('deposit.html')!==-1) {
          n.textContent = n.textContent.replace(/deposit\.html/g,'').trim();
          if (!n.textContent) n.remove();
        }
      });
      // remove elements whose visible text equals the filename
      document.querySelectorAll('body *').forEach(el=>{
        const t = (el.textContent||'').trim();
        if (t === 'deposit.html') el.remove();
      });
    }catch(e){ /* noop */ }
  </script>
  

  <main class="max-w-4xl mx-auto p-6 pb-12">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Bank Funding Details -->
      <section class="bg-white rounded-lg p-6 shadow-lg">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Bank Funding Details</h2>
          <small class="text-xs text-slate-500">Send a bank transfer to ABU</small>
        </div>

        <p class="text-sm text-slate-600 mb-4">Use the account details below to fund your ABU account. Choose an account type if multiple options are available.</p>

        <div class="mb-4">
          <label class="block text-xs text-slate-600 mb-2">Account Type</label>
          <select id="abuAccountType" class="w-full border rounded px-3 py-2 text-sm">
            <option value="savings">Savings</option>
            <option value="current">Current</option>
          </select>
        </div>

        <div class="space-y-3 text-sm text-slate-700">
          <div class="flex items-center justify-between gap-4">
            <div>
              <div class="text-xs text-slate-500">Account Number</div>
              <div id="abuAcctNumber" class="font-medium">—</div>
            </div>
            <button class="copy-btn text-xs text-indigo-600" data-copy-target="abuAcctNumber">Copy</button>
          </div>

          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-500">Account Name</div>
              <div id="abuAcctName" class="font-medium">—</div>
            </div>
            <button class="copy-btn text-xs text-indigo-600" data-copy-target="abuAcctName">Copy</button>
          </div>

          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-500">SWIFT / BIC</div>
              <div id="abuSwift" class="font-medium">—</div>
            </div>
            <button class="copy-btn text-xs text-indigo-600" data-copy-target="abuSwift">Copy</button>
          </div>

          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-500">IBAN</div>
              <div id="abuIban" class="font-medium">—</div>
            </div>
            <button class="copy-btn text-xs text-indigo-600" data-copy-target="abuIban">Copy</button>
          </div>

          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-500">Phone</div>
              <div id="abuPhone" class="font-medium">—</div>
            </div>
            <button class="copy-btn text-xs text-indigo-600" data-copy-target="abuPhone">Copy</button>
          </div>

          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-500">Email</div>
              <div id="abuEmail" class="font-medium">—</div>
            </div>
            <button class="copy-btn text-xs text-indigo-600" data-copy-target="abuEmail">Copy</button>
          </div>
        </div>
      </section>

      <!-- Card list -->
      <section class="bg-white rounded-lg p-6 shadow-lg">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">ABU Cards</h2>
          <small class="text-xs text-slate-500">Use a saved card to fund instantly</small>
        </div>

        <p class="text-sm text-slate-600 mb-4">Select one of your saved ABU cards. You can add a new card from your profile if needed.</p>

        <ul id="abuCardList" class="space-y-3 max-h-64 overflow-auto">
          <!-- cards populated by JS -->
        </ul>

        <div class="mt-4">
          <a href="cards.html" class="text-sm text-indigo-600">Manage cards</a>
        </div>
      </section>
    </div>
  </main>

  <script src="js/utils.js?v=20260121.2"></script>
  <script src="js/api.js?v=20260121.2"></script>
  <script src="js/auth.js?v=20260121.2"></script>
  <script src="js/dashboard-api.js?v=20260121.2"></script>
  <script src="js/features.js?v=20260121.2"></script>
  <script src="js/ui.js?v=20260121.2"></script>
  <script>
    // Populate deposit page with sample ABU bank details and saved cards
    async function populateDepositDetails(){
      // sample bank details per account type
      const banks = {
        savings: {
          acctNumber: '1234567890',
          acctName: 'American Bank United - Client Trust',
          swift: 'ABUUS33',
          iban: 'GB29ABU01234567890123',
          phone: '+1 800 555 0100',
          email: 'support@abu-bank.com'
        },
        current: {
          acctNumber: '0987654321',
          acctName: 'American Bank United - Current',
          swift: 'ABUUS44',
          iban: 'GB29ABU98765432109876',
          phone: '+1 800 555 0199',
          email: 'treasury@abu-bank.com'
        }
      };

      const cards = [
        {id: 'c1', brand: 'visa', masked: '**** **** **** 4242', name: 'JOHN DOE', exp: '12/26'},
        {id: 'c2', brand: 'mastercard', masked: '**** **** **** 1111', name: 'JANE DOE', exp: '09/25'}
      ];

      const acctTypeEl = document.getElementById('abuAccountType');

      // get current user (if authenticated) and use their name/email/phone when available
      let currentUser = null;
      try{
        if (typeof getCurrentUser === 'function') {
          currentUser = await getCurrentUser();
        }
      }catch(e){ console.warn('getCurrentUser failed', e); }

      const setBank = (type)=>{
        const data = banks[type] || banks.savings;
        document.getElementById('abuAcctNumber').textContent = data.acctNumber;

        // Account name should be the real name used at account creation when available
        const acctName = currentUser ? ((currentUser.first_name || '') + ' ' + (currentUser.last_name || '')).trim() || data.acctName : data.acctName;
        document.getElementById('abuAcctName').textContent = acctName;

        document.getElementById('abuSwift').textContent = data.swift;
        document.getElementById('abuIban').textContent = data.iban;

        // Phone: leave empty if user has not added a phone number
        const phoneValue = currentUser ? (currentUser.phone || currentUser.phone_number || '') : data.phone || '';
        document.getElementById('abuPhone').textContent = phoneValue;

        // Email should be the email used at account creation when available
        const emailValue = currentUser ? (currentUser.email || currentUser.email_address || data.email) : data.email;
        document.getElementById('abuEmail').textContent = emailValue;
      };

      // initial set
      setBank(acctTypeEl.value || 'savings');

      acctTypeEl.addEventListener('change', (e)=> setBank(e.target.value));

      // populate cards
      const cardList = document.getElementById('abuCardList');
      cardList.innerHTML = '';
      cards.forEach(c=>{
        const li = document.createElement('li');
        li.className = 'p-3 border rounded flex items-center justify-between';
        li.innerHTML = `
          <div>
            <div class="text-sm font-medium">${c.brand.toUpperCase()} • ${c.masked}</div>
            <div class="text-xs text-slate-500">${c.name} • Exp ${c.exp}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-outline use-card" data-card-id="${c.id}">Use</button>
          </div>
        `;
        cardList.appendChild(li);
      });

      // copy buttons
      document.querySelectorAll('.copy-btn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const target = document.getElementById(btn.dataset.copyTarget);
          if (!target) return;
          try{
            await navigator.clipboard.writeText(target.textContent.trim());
            btn.textContent = 'Copied';
            setTimeout(()=> btn.textContent = 'Copy', 1400);
          }catch(e){
            console.warn('copy failed', e);
          }
        });
      });

      // use card action
      document.querySelectorAll('.use-card').forEach(b=>{
        b.addEventListener('click', ()=>{
          const cardId = b.dataset.cardId;
          // store selected card and redirect to quick deposit flow
          localStorage.setItem('abu_selected_card', cardId);
          window.location.href = 'transfer.html';
        });
      });
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await populateDepositDetails();
    });
  </script>
</body>
</html>